<!DOCTYPE html>
<html>
<head>
    <title>30 Seconds Game - TV Display</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: white;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .tv-header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            text-align: center;
            border-bottom: 3px solid #FFD23F;
        }
        
        .tv-title {
            font-size: 2.5rem;
            font-weight: 900;
            color: #FFD23F;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            margin: 0;
        }
        
        .tv-game-info {
            font-size: 1.2rem;
            margin-top: 8px;
            opacity: 0.9;
        }
        
        .tv-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }
        
        .tv-game-state {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .tv-current-turn {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 3px solid #06FFA5;
        }
        
        .tv-player-info {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .tv-round-info {
            font-size: 1.5rem;
            opacity: 0.8;
        }
        
        .tv-scoreboard {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
        }
        
        .tv-scoreboard h3 {
            margin: 0 0 15px 0;
            text-align: center;
            font-size: 1.5rem;
            color: #FFD23F;
        }
        
        .tv-scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .tv-team-card {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #00B4D8;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .tv-team-card.active {
            border-color: #06FFA5;
            background: rgba(6, 255, 165, 0.2);
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(6, 255, 165, 0.3);
        }
        
        .tv-team-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .tv-team-score {
            font-size: 2rem;
            font-weight: 900;
            color: #FFD23F;
        }
        
        .tv-game-section {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            display: none;
        }
        
        .tv-game-section.active {
            display: block;
        }
        
        .tv-dice-display {
            text-align: center;
            padding: 20px;
        }
        
        .tv-dice-value {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(135deg, #00B4D8, #0077B6);
            border-radius: 20px;
            padding: 20px 40px;
            margin: 20px;
            border: 3px solid #FFD23F;
            display: inline-block;
        }
        
        .tv-dice-meaning {
            font-size: 1.3rem;
            margin-top: 15px;
            opacity: 0.9;
        }
        
        .tv-timer-display {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .tv-timer {
            font-size: 5rem;
            font-weight: 900;
            color: #06FFA5;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        
        .tv-timer.warning {
            color: #FF6B35;
            animation: pulse 1s infinite;
        }
        
        .tv-timer.urgent {
            color: #FF006E;
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .tv-category {
            text-align: center;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #FFD23F;
        }
        
        .waiting-message {
            text-align: center;
            font-size: 2rem;
            opacity: 0.8;
            animation: fadeInOut 2s ease-in-out infinite;
            margin-top: 50px;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .tv-status-message {
            text-align: center;
            font-size: 1.5rem;
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
        }
        
        .tv-status-message p {
            font-size: 1.8rem;
            margin: 10px 0;
        }
        
        /* NEW STYLES FOR QUESTION PROGRESS */
        .tv-questions-progress {
            max-width: 600px;
            margin: 20px auto;
            text-align: center;
        }
        
        .progress-info {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .questions-summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .questions-total,
        .questions-correct {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .questions-total {
            color: #00B4D8;
        }
        
        .questions-correct {
            color: #06FFA5;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #06FFA5, #00B4D8);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .final-results-display {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .result-summary {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            padding: 25px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            font-size: 1.5rem;
        }
        
        .result-label {
            font-weight: 600;
            color: #FFD23F;
        }
        
        .result-value {
            font-weight: 900;
            font-size: 2rem;
            color: #06FFA5;
        }
    </style>
</head>
<body>
    <div class="tv-header">
        <h1 class="tv-title">30 SECONDS GAME</h1>
        <div class="tv-game-info" id="gameInfo">Ready to cast your game!</div>
    </div>
    
    <div class="tv-content" id="tvContent">
        <div class="waiting-message" id="waitingMessage">
            ðŸŽ® Waiting for game to start...
        </div>
        
        <div class="tv-game-state" id="gameState" style="display: none;">
            <!-- Current Turn Info -->
            <div class="tv-current-turn" id="currentTurn">
                <div class="tv-player-info" id="playerInfo">Player's Turn</div>
                <div class="tv-round-info" id="roundInfo">Round 1</div>
            </div>
            
            <!-- Scoreboard -->
            <div class="tv-scoreboard" id="scoreboard">
                <h3>Current Standings</h3>
                <div class="tv-scores-grid" id="scoresGrid">
                    <!-- Team scores will appear here -->
                </div>
            </div>
            
            <!-- Dice Section -->
            <div class="tv-game-section" id="diceSection">
                <div class="tv-dice-display">
                    <div class="tv-dice-value" id="diceValue">0</div>
                    <div class="tv-dice-meaning" id="diceMeaning">Roll the dice to start!</div>
                </div>
            </div>
            
            <!-- Card Section -->
            <div class="tv-game-section" id="cardSection">
                <div class="tv-status-message">
                    <div class="tv-category" id="category">Ready to draw card...</div>
                    <p>Prepare to describe 5 words!</p>
                </div>
            </div>
            
            <!-- Timer Section -->
            <div class="tv-game-section" id="timerSection">
                <div class="tv-timer-display">
                    <div class="tv-timer" id="timer">30</div>
                </div>
                
                <!-- Show progress instead of actual questions -->
                <div class="tv-questions-progress" id="questionsProgress">
                    <div class="tv-category" id="timerCategory">Category Name</div>
                    <div class="progress-info">
                        <div class="questions-summary">
                            <div class="questions-total">
                                <i class="fas fa-list"></i>
                                <span id="questionsTotal">5</span> Questions
                            </div>
                            <div class="questions-correct">
                                <i class="fas fa-check-circle"></i>
                                <span id="questionsCorrect">0</span> Correct
                            </div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="questionsProgressBar"></div>
                        </div>
                    </div>
                </div>
                
                <div class="tv-status-message">
                    <p><span id="currentPlayerTimer">Player</span> is describing...</p>
                </div>
            </div>
            
            <!-- Results Section -->
            <div class="tv-game-section" id="resultsSection">
                <div class="tv-status-message">
                    <h3>Time's Up!</h3>
                    <p>Final Results:</p>
                </div>
                <div class="final-results-display" id="finalResultsDisplay">
                    <div class="result-summary">
                        <div class="result-item">
                            <span class="result-label">Questions:</span>
                            <span class="result-value" id="finalQuestionsTotal">5</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Correct:</span>
                            <span class="result-value" id="finalQuestionsCorrect">0</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">Points Earned:</span>
                            <span class="result-value" id="pointsEarned">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    <script>
        const context = cast.framework.CastReceiverContext.getInstance();
        
        // Listen for custom messages
context.addCustomMessageListener('urn:x-cast:com.thirtyseconds.game', (event) => {
    console.log('Raw message received:', event.data);
    
    // Check if the message is already an object
    let data;
    if (typeof event.data === 'string') {
        try {
            data = JSON.parse(event.data);
        } catch (error) {
            console.error('JSON Parse Error:', error);
            console.error('Raw data:', event.data);
            document.getElementById('gameInfo').textContent = 'JSON Error: ' + event.data;
            return;
        }
    } else if (typeof event.data === 'object') {
        data = event.data;
    } else {
        console.error('Unexpected data type:', typeof event.data);
        document.getElementById('gameInfo').textContent = 'Data Type Error: ' + typeof event.data;
        return;
    }
    
    console.log('Parsed data:', data);
    
    if (data.type === 'test') {
        document.getElementById('gameInfo').textContent = 'Test: ' + data.message;
        return;
    }
    
    handleGameData(data);
});
        
        // Send ready message when receiver starts
        context.sendCustomMessage('urn:x-cast:com.thirtyseconds.game', undefined, {
            type: 'receiver_ready',
            timestamp: Date.now()
        });
        
        function handleGameData(data) {
            console.log('Handling game data:', data);
            
            switch (data.type) {
                case 'fullGameState':
                    updateFullGameDisplay(data);
                    break;
                    
                case 'dice_rolled':
                    showDiceResult(data);
                    break;
                    
                case 'card_drawn':
                    showCardDrawn(data);
                    break;
                    
                case 'timer_started':
                    showTimer(data);
                    break;
                    
                case 'timer_update':
                    updateTimer(data);
                    break;
                    
                case 'answers_submitted':
                    showAnswersSubmitted(data);
                    break;
                    
                default:
                    console.log('Unknown message type:', data.type);
                    // Show debug info
                    document.getElementById('gameInfo').textContent = 
                        'Received: ' + data.type + ' at ' + new Date().toLocaleTimeString();
            }
        }
        
        function updateFullGameDisplay(data) {
            console.log('Updating full game display:', data);
            
            // IMPORTANT: Show game state immediately, hide waiting message
            document.getElementById('waitingMessage').style.display = 'none';
            document.getElementById('gameState').style.display = 'flex';
            
            // Update game info header
            document.getElementById('gameInfo').textContent = 
                `Round ${data.currentRound} - ${data.currentPlayer} (${data.currentTeam})`;
            
            // Update current turn info
            document.getElementById('playerInfo').textContent = 
                `${data.currentPlayer} (${data.currentTeam})`;
            document.getElementById('roundInfo').textContent = 
                `Round ${data.currentRound}`;
            
            // Update scoreboard
            if (data.scores && data.scores.length > 0) {
                const scoresGrid = document.getElementById('scoresGrid');
                scoresGrid.innerHTML = data.scores.map(team => `
                    <div class="tv-team-card ${team.name === data.currentTeam ? 'active' : ''}">
                        <div class="tv-team-name">${team.name}</div>
                        <div class="tv-team-score">${team.score}</div>
                    </div>
                `).join('');
            }
            
            // Show appropriate section based on game status
            hideAllSections();
            
            // Handle different game states
            if (data.gameStatus === 'setup' || !data.gameStatus) {
                showDiceSection(data);
            } else if (data.gameStatus === 'dice') {
                showDiceSection(data);
            } else if (data.gameStatus === 'card') {
                showCardSection(data);
            } else if (data.gameStatus === 'timer') {
                showTimerSection(data);
            } else if (data.gameStatus === 'results') {
                showResultsSection(data);
            } else if (data.gameStatus === 'active') {
                // For active games, show based on other indicators
                if (data.timerActive) {
                    showTimerSection(data);
                } else if (data.cardDrawn) {
                    showCardSection(data);
                } else if (data.diceValue !== null && data.diceValue !== undefined) {
                    showDiceSection(data);
                } else {
                    showDiceSection(data);
                }
            } else {
                // Default to dice section if unclear
                showDiceSection(data);
            }
        }
        
        function hideAllSections() {
            document.querySelectorAll('.tv-game-section').forEach(section => {
                section.classList.remove('active');
            });
        }
        
        function showDiceSection(data) {
            document.getElementById('diceSection').classList.add('active');
            
            if (data.diceValue !== null && data.diceValue !== undefined) {
                document.getElementById('diceValue').textContent = data.diceValue;
                const meanings = {
                    0: 'Full points for each correct answer!',
                    1: 'Need more than 1 correct to score points!',
                    2: 'Need more than 2 correct to score points!'
                };
                document.getElementById('diceMeaning').textContent = 
                    meanings[data.diceValue] || 'Roll complete!';
            } else {
                document.getElementById('diceMeaning').textContent = 'Roll the dice to start!';
            }
        }
        
        function showCardSection(data) {
            document.getElementById('cardSection').classList.add('active');
            
            if (data.currentCategory) {
                document.getElementById('category').textContent = data.currentCategory;
            }
            
            // Show questions count if available
            if (data.questionsCount) {
                const categoryElement = document.getElementById('category');
                categoryElement.textContent = `${data.currentCategory || 'Questions'} (${data.questionsCount} questions)`;
            }
        }
        
        function showTimerSection(data) {
            document.getElementById('timerSection').classList.add('active');
            
            // Update timer
            if (data.timeRemaining !== undefined) {
                const timerElement = document.getElementById('timer');
                timerElement.textContent = data.timeRemaining;
                
                // Apply warning classes
                timerElement.className = 'tv-timer';
                if (data.timeRemaining <= 5) {
                    timerElement.classList.add('urgent');
                } else if (data.timeRemaining <= 10) {
                    timerElement.classList.add('warning');
                }
            }
            
            // Update category
            if (data.currentCategory) {
                document.getElementById('timerCategory').textContent = data.currentCategory;
            }
            
            // Update current player
            if (data.currentPlayer) {
                document.getElementById('currentPlayerTimer').textContent = data.currentPlayer;
            }
            
            // Show progress instead of questions
            const questionsTotal = data.questionsCount || 5;
            const questionsCorrect = data.correctAnswersCount || 0;
            
            document.getElementById('questionsTotal').textContent = questionsTotal;
            document.getElementById('questionsCorrect').textContent = questionsCorrect;
            
            // Update progress bar
            const progressPercent = questionsTotal > 0 ? (questionsCorrect / questionsTotal) * 100 : 0;
            document.getElementById('questionsProgressBar').style.width = progressPercent + '%';
        }
        
        function showResultsSection(data) {
            document.getElementById('resultsSection').classList.add('active');
            
            // Show final results summary
            const questionsTotal = data.questionsCount || 5;
            const questionsCorrect = data.correctAnswersCount || 0;
            
            document.getElementById('finalQuestionsTotal').textContent = questionsTotal;
            document.getElementById('finalQuestionsCorrect').textContent = questionsCorrect;
            
            // Calculate points based on dice value (if available)
            let pointsEarned = 0;
            if (data.diceValue !== undefined) {
                if (data.diceValue === 0) {
                    pointsEarned = questionsCorrect;
                } else {
                    pointsEarned = Math.max(0, questionsCorrect - data.diceValue);
                }
                
                // Double points if active
                if (data.doubleActive) {
                    pointsEarned *= 2;
                }
            }
            
            document.getElementById('pointsEarned').textContent = pointsEarned;
        }
        
        function updateTimer(data) {
            // Update timer display
            if (data.timeRemaining !== undefined) {
                const timerElement = document.getElementById('timer');
                timerElement.textContent = data.timeRemaining;
                
                // Apply warning classes
                timerElement.className = 'tv-timer';
                if (data.timeRemaining <= 5) {
                    timerElement.classList.add('urgent');
                } else if (data.timeRemaining <= 10) {
                    timerElement.classList.add('warning');
                }
            }
            
            // Update progress
            if (data.correctAnswersCount !== undefined && data.questionsCount !== undefined) {
                document.getElementById('questionsCorrect').textContent = data.correctAnswersCount;
                document.getElementById('questionsTotal').textContent = data.questionsCount;
                
                // Update progress bar
                const progressPercent = data.questionsCount > 0 ? (data.correctAnswersCount / data.questionsCount) * 100 : 0;
                document.getElementById('questionsProgressBar').style.width = progressPercent + '%';
            }
        }
        
        function showAnswersSubmitted(data) {
            // Show final results
            showResultsSection(data);
            
            // Update with submitted answer data
            if (data.correctCount !== undefined) {
                document.getElementById('finalQuestionsCorrect').textContent = data.correctCount;
            }
            
            if (data.pointsEarned !== undefined) {
                document.getElementById('pointsEarned').textContent = data.pointsEarned;
            }
        }
        
        // Legacy handlers for individual events
        function showDiceResult(data) {
            showDiceSection({ diceValue: data.diceValue });
        }
        
        function showCardDrawn(data) {
            showCardSection({ 
                currentCategory: data.category,
                questionsCount: data.questionsCount || 5
            });
        }
        
        function showTimer(data) {
            showTimerSection({ 
                timeRemaining: data.timeRemaining,
                currentCategory: data.category,
                questionsCount: data.questionsCount || 5,
                correctAnswersCount: data.correctAnswersCount || 0
            });
        }
        
        // Start the receiver
        context.start();
        
        console.log('30 Seconds Game Chromecast Receiver loaded');
    </script>
</body>
</html>
